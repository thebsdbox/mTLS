# WIP

## How to Run

First build and run the eBPF program:
```
go generate
go build
sudo ./proxy
```

## Original Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pod01     â”‚          â”‚ Pod01     â”‚
â”‚ 10.0.0.1  â”¼â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â–º 10.0.0.2  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                  
                 â”‚                  
                 â”‚                  
            CNI Magic ðŸ§™ðŸ»â€â™‚ï¸
```

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Pod-01                           â”‚                     â”‚                           Pod-02â”‚
â”‚10.0.0.1 xâ”€xâ”€xâ”€xâ”€â–º 10.0.2.2:80   â”‚                     â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º  10.0.2.2â”‚
â”‚   â”‚  eBPF captures the socket   â”‚                     â”‚     â”‚   :80                     â”‚
â”‚   â”‚  Finds original destination â”‚                     â”‚     â”‚                           â”‚
â”‚   â”‚  Changes destination to lo  â”‚                     â”‚     â”‚                           â”‚
â”‚   â”‚                             â”‚                     â”‚     â”‚                           â”‚
â”‚   â–¼  Our TLS listener sends     â”‚                     â”‚     â”‚                           â”‚
â”‚127.0.0.1:18000                  â”‚                     â”‚0.0.0.0:18001                    â”‚
â”‚         â”‚                       â”‚                     â”‚     â–²                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                                                   â”‚                            
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ðŸ”â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            
            Uses original destination with a modified port                                 
```



`client 0.0.0.0:30000 -> 151.101.129.140:80`
`client 0.0.0.0:30000 -> 127.0.0.1:18000`
`Get original destination address/port from socket`
`Change dest port to 18001`
`0.0.0.0:30001 -> 151.101.129.140:18001`
`send original port`
`151.101.129.140:30002 -> 151.101.129.140:80`
`TLS between 0.0.0.0:30001 -> 151.101.129.140:18001`

You can then inspect eBPF logs using `sudo cat /sys/kernel/debug/tracing/trace_pipe` to verify transparent proxy indeed intercepts the network traffic.
